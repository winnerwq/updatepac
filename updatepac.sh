#!/bin/bash
GFWLIST_URL="https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt"

PROXY="127.0.0.1:1081"

function _convert() {
	_method=$1
	_pacfile_name="$2"
	if [[ "${_pacfile_name}" == '' ]]; then
		case ${_method} in
		[123])
			_pacfile_name="pac-gfw.js"
			;;

		4)
			_pacfile_name="gfw.conf"
			;;
		esac
	fi
	case ${_method} in
	1)
		G2P="/usr/local/bin/gfwlist2pac"
		_pip="pip"
		;;
	2)
		G2P="/Library/Frameworks/Python.framework/Versions/3.7/bin/genpac"
		_pip="pip3"
		;;
	esac

	if [[ ${_method} =~ [12] && ! -x "${G2P}" ]]; then
		echo "${G2P##*/} is not installed on your mac, please use this command to install:"
		echo "    sudo ${_pip} install ${G2P##*/}"
		exit 0
	fi

	_localgfw="${PWD}/gfwlist.txt"
	_gfwlist="$(mktemp -t gfwlist)"
	USING_EXISTING_GFWLIST=0

	if [[ -f "${_localgfw}" ]]; then
		USING_EXISTING_GFWLIST=1
		base64 --decode --input="${_localgfw}" 1>"${_gfwlist}"
		if [[ $? -ne 0 ]]; then
			cat "${_localgfw}" >"${_gfwlist}"
		fi
	else
		echo "Downloading ${GFWLIST_URL}..."
		case ${_method} in
		[13])
			curl "${GFWLIST_URL}" --fail --socks5-hostname "${PROXY}" | base64 --decode >"${_gfwlist}"
			;;
		2)
			curl "${GFWLIST_URL}" --socks5-hostname "${PROXY}" >"${_gfwlist}"
			;;
		esac
	fi

	# generated js file path
	V2RAY_PATH="${HOME}/Library/Application Support/V2RayX/pac"
	if [[ ${_method} =~ [123] && -d "${V2RAY_PATH}" ]]; then
		PACPATH="${V2RAY_PATH}"
	else
		PACPATH="${PWD}"
	fi

	PACFILE="${PACPATH}/${_pacfile_name}"
	case ${_method} in
	1)
		_cmd="${G2P} --input \"${_gfwlist}\" \
			--file \"${PACFILE}\" \
			--proxy \"SOCKS5 ${PROXY}; SOCKS ${PROXY}; DIRECT;\" \
			--precise \
			"
		;;
	2)
		_cmd="${G2P} --gfwlist-local \"${_gfwlist}\" \
			--output \"${PACFILE}\" \
			--pac-proxy \"SOCKS5 ${PROXY}; SOCKS ${PROXY}; DIRECT;\" \
			--format pac \
			--pac-precise \
			"
		;;
	3)
		# below is regular rules that gfwlist2pac tool will add, no idea why
		echo '||google.com
			||google.co.jp
			||google.co.hk
			||bbc.co.uk
			||googleapis.com
			||googlesyndication.com
			||github.com
			||wikipedia.org' | sed -e 's/[[:blank:]]//g' >>"${_gfwlist}"
		;;
	4)
		awk 'NR==FNR && NR>1 && /^[^!]/{
				gsub(/\\/,"\\\\",$0);
				if($0 ~ /^[|.]/){
					gsub(/^[|.]+/,"",$0);
					ap[$0]=1;
				} else if ($0 ~ /^[@]/){
					gsub(/^[@]+/,"",$0);
					ad[$0]=0;
				}
			}NR>FNR{
				if ( $0 ~ /{{RULES}}/ ){
					for(i=0;i<length(a);i++){
						printf("  \"%s\",\n",a[i])
					}
				} else {
					print $0;
				}
			}' "${_gfwlist}" "${_pac_temp}" less
		exit 0
		;;
	esac

	USER_RULE="${HOME}/.ShadowsocksX-NG/user-rule.txt"
	if [[ -f "${USER_RULE}" ]]; then
		echo "User rules in [${USER_RULE}] was found."
		case ${_method} in
		1)
			_cmd="${_cmd} --user-rule \"${USER_RULE}\""
			;;
		2)
			_cmd="${_cmd} --user-rule-from \"${USER_RULE}\""
			;;
		3)
			cat "${USER_RULE}" >>"${_gfwlist}"
			;;
		4)
			echo "Converting gfwlist to sr-conf file: ${PACFILE}"
			_sr_temp="$(mktemp -t tmppaccode)"
			echo "${SR_BASE_CODE}" | base64 --decode --output="${_sr_temp}"
			;;
		esac
	fi

	case ${_method} in
	[12])
		echo "Converting gfwlist using command as below:"
		echo "${_cmd}"
		eval "${_cmd}"
		;;
	3)
		echo "Converting gfwlist to ${PACFILE}"
		_pac_temp="$(mktemp -t pactemp)"
		echo "${PAC_BASE_CODE}" | base64 --decode 1>"${_pac_temp}"
		awk 'BEGIN{i=0}NR==FNR && NR>1 && $0!~/^[ \t]*$/ && /^[^!]/{gsub(/\\/,"\\\\",$0);a[i++]=$0}NR>FNR{
			if ( $0 ~ /{{PROXY}}/ ){
				gsub("{{PROXY}}","\"SOCKS5 '"${PROXY}"'; SOCKS '"${PROXY}"'; DIRECT;\"",$0);
				print $0;
			} else if ( $0 ~ /{{RULES}}/ ){
				len=length(a);
				for(i=0;i<len;i++){
					printf("  \"%s\"",a[i]);
					if (i<len-1){q
						printf(",");
					}
					printf("\n");
				}
			} else {
				print $0;
			}
		}' "${_gfwlist}" "${_pac_temp}" 1>"${PACFILE}"
		rm -f "${_pac_temp}"
		;;
	4) ;;

	esac

	case ${_method} in
	[123]) _comment_lead="//" ;;
	4) _comment_lead="#" ;;
	esac

	_gfw_desc="$(awk '/^![ \t]*Expires/{expired=$NF}/^![ \t]*Last Modified/{gsub(/^![ \t]*L/,"",$0);printf("GFWList file l%s, expires in %s.\n",$0,expired)}' ${_gfwlist})"
	sed -i '' -e '1 i\
		'"${_comment_lead}"' '"${_gfw_desc}"'\
		'"${_comment_lead}"' This pac generated at ['"$(date '+%Y-%m-%d %H:%M:%S')"']' "${PACFILE}"

	if [[ ${USING_EXISTING_GFWLIST} -eq 0 ]]; then
		rm -f "${_gfwlist}"
	fi

	echo "Done."
}

# base code is what i copied from gfwlsit2pac generated js
PAC_BASE_CODE='Ly8gR2VuZXJhdGVkIGJ5IGdmd2xpc3QycGFjIGluIHByZWNpc2UgbW9kZQovLyBodHRwczovL2dpdGh1Yi5jb20vY2xvd3dpbmR5
L2dmd2xpc3QycGFjCgp2YXIgcHJveHkgPSB7e1BST1hZfX07Cgp2YXIgcnVsZXMgPSBbCiAge3tSVUxFU319Cl07CgovKgoqIFRo
aXMgZmlsZSBpcyBwYXJ0IG9mIEFkYmxvY2sgUGx1cyA8aHR0cDovL2FkYmxvY2twbHVzLm9yZy8+LAoqIENvcHlyaWdodCAoQykg
MjAwNi0yMDE0IEV5ZW8gR21iSAoqCiogQWRibG9jayBQbHVzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRl
IGl0IGFuZC9vciBtb2RpZnkKKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIHZl
cnNpb24gMyBhcwoqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLgoqCiogQWRibG9jayBQbHVzIGlz
IGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZ
OyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQ
QVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4K
KgoqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiogYWxv
bmcgd2l0aCBBZGJsb2NrIFBsdXMuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiovCgpmdW5j
dGlvbiBjcmVhdGVEaWN0KCkKewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgcmVzdWx0Ll9fcHJvdG9fXyA9IG51bGw7CiAgICBy
ZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpCnsKICAgIGlmIChvYmou
aGFzT3duUHJvcGVydHkoa2V5KSkKICAgIHsKICAgICAgICByZXR1cm4gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gbnVsbDsK
fQoKZnVuY3Rpb24gZXh0ZW5kKHN1YmNsYXNzLCBzdXBlcmNsYXNzLCBkZWZpbml0aW9uKQp7CiAgICBpZiAoT2JqZWN0Ll9fcHJv
dG9fXykKICAgIHsKICAgICAgICBkZWZpbml0aW9uLl9fcHJvdG9fXyA9IHN1cGVyY2xhc3MucHJvdG90eXBlOwogICAgICAgIHN1
YmNsYXNzLnByb3RvdHlwZSA9IGRlZmluaXRpb247CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdmFyIHRtcGNsYXNzID0g
ZnVuY3Rpb24oKXt9LCByZXQ7CiAgICAgICAgdG1wY2xhc3MucHJvdG90eXBlID0gc3VwZXJjbGFzcy5wcm90b3R5cGU7CiAgICAg
ICAgc3ViY2xhc3MucHJvdG90eXBlID0gbmV3IHRtcGNsYXNzKCk7CiAgICAgICAgc3ViY2xhc3MucHJvdG90eXBlLmNvbnN0cnVj
dG9yID0gc3VwZXJjbGFzczsKICAgICAgICBmb3IgKHZhciBpIGluIGRlZmluaXRpb24pCiAgICAgICAgewogICAgICAgICAgICBp
ZiAoZGVmaW5pdGlvbi5oYXNPd25Qcm9wZXJ0eShpKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3ViY2xhc3MucHJv
dG90eXBlW2ldID0gZGVmaW5pdGlvbltpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gRmlsdGVy
KHRleHQpCnsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTsKfQpGaWx0ZXIucHJvdG90
eXBlID0gewogICAgdGV4dDogbnVsbCwKICAgIHN1YnNjcmlwdGlvbnM6IG51bGwsCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKQog
ICAgewogICAgICAgIHJldHVybiB0aGlzLnRleHQ7CiAgICB9Cn07CkZpbHRlci5rbm93bkZpbHRlcnMgPSBjcmVhdGVEaWN0KCk7
CkZpbHRlci5lbGVtaGlkZVJlZ0V4cCA9IC9eKFteXC9cKlx8XEAiIV0qPykjKFxAKT8oPzooW1x3XC1dK3xcKikoKD86XChbXHdc
LV0rKD86WyReKl0/PVteXChcKSJdKik/XCkpKil8IyhbXnt9XSspKSQvOwpGaWx0ZXIucmVnZXhwUmVnRXhwID0gL14oQEApP1wv
LipcLyg/Olwkfj9bXHdcLV0rKD86PVteLFxzXSspPyg/Oix+P1tcd1wtXSsoPzo9W14sXHNdKyk/KSopPyQvOwpGaWx0ZXIub3B0
aW9uc1JlZ0V4cCA9IC9cJCh+P1tcd1wtXSsoPzo9W14sXHNdKyk/KD86LH4/W1x3XC1dKyg/Oj1bXixcc10rKT8pKikkLzsKRmls
dGVyLmZyb21UZXh0ID0gZnVuY3Rpb24odGV4dCkKewogICAgaWYgKHRleHQgaW4gRmlsdGVyLmtub3duRmlsdGVycykKICAgIHsK
ICAgICAgICByZXR1cm4gRmlsdGVyLmtub3duRmlsdGVyc1t0ZXh0XTsKICAgIH0KICAgIHZhciByZXQ7CiAgICBpZiAodGV4dC5j
aGFyQXQoMCkgPT0gIiEiKQogICAgewogICAgICAgIHJldCA9IG5ldyBDb21tZW50RmlsdGVyKHRleHQpOwogICAgfQogICAgZWxz
ZQogICAgewogICAgICAgIHJldCA9IFJlZ0V4cEZpbHRlci5mcm9tVGV4dCh0ZXh0KTsKICAgIH0KICAgIEZpbHRlci5rbm93bkZp
bHRlcnNbcmV0LnRleHRdID0gcmV0OwogICAgcmV0dXJuIHJldDsKfTsKCmZ1bmN0aW9uIEludmFsaWRGaWx0ZXIodGV4dCwgcmVh
c29uKQp7CiAgICBGaWx0ZXIuY2FsbCh0aGlzLCB0ZXh0KTsKICAgIHRoaXMucmVhc29uID0gcmVhc29uOwp9CmV4dGVuZChJbnZh
bGlkRmlsdGVyLCBGaWx0ZXIsIHsKICAgIHJlYXNvbjogbnVsbAp9KTsKCmZ1bmN0aW9uIENvbW1lbnRGaWx0ZXIodGV4dCkKewog
ICAgRmlsdGVyLmNhbGwodGhpcywgdGV4dCk7Cn0KZXh0ZW5kKENvbW1lbnRGaWx0ZXIsIEZpbHRlciwgewp9KTsKCmZ1bmN0aW9u
IEFjdGl2ZUZpbHRlcih0ZXh0LCBkb21haW5zKQp7CiAgICBGaWx0ZXIuY2FsbCh0aGlzLCB0ZXh0KTsKICAgIHRoaXMuZG9tYWlu
U291cmNlID0gZG9tYWluczsKfQpleHRlbmQoQWN0aXZlRmlsdGVyLCBGaWx0ZXIsIHsKICAgIGRvbWFpblNvdXJjZTogbnVsbCwK
ICAgIGRvbWFpblNlcGFyYXRvcjogbnVsbCwKICAgIGlnbm9yZVRyYWlsaW5nRG90OiB0cnVlLAogICAgZG9tYWluU291cmNlSXNV
cHBlckNhc2U6IGZhbHNlLAogICAgZ2V0RG9tYWluczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBwcm9wID0gZ2V0T3du
UHJvcGVydHlEZXNjcmlwdG9yKHRoaXMsICJkb21haW5zIik7CiAgICAgICAgaWYgKHByb3ApCiAgICAgICAgewogICAgICAgICAg
ICByZXR1cm4gcHJvcDsKICAgICAgICB9CiAgICAgICAgdmFyIGRvbWFpbnMgPSBudWxsOwogICAgICAgIGlmICh0aGlzLmRvbWFp
blNvdXJjZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLmRvbWFpblNvdXJjZTsKICAgICAgICAgICAg
aWYgKCF0aGlzLmRvbWFpblNvdXJjZUlzVXBwZXJDYXNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzb3VyY2UgPSBz
b3VyY2UudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGlzdCA9IHNvdXJjZS5zcGxpdCh0aGlz
LmRvbWFpblNlcGFyYXRvcik7CiAgICAgICAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PSAxICYmIGxpc3RbMF0uY2hhckF0KDApICE9
ICJ+IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZG9tYWlucyA9IGNyZWF0ZURpY3QoKTsKICAgICAgICAgICAgICAg
IGRvbWFpbnNbIiJdID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pZ25vcmVUcmFpbGluZ0RvdCkKICAgICAgICAg
ICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBsaXN0WzBdID0gbGlzdFswXS5yZXBsYWNlKC9cLiskLywgIiIpOwogICAgICAg
ICAgICAgICAgfQogICAgICAgICAgICAgICAgZG9tYWluc1tsaXN0WzBdXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAg
ICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaGFzSW5jbHVkZXMgPSBmYWxzZTsKICAgICAgICAgICAg
ICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAg
ICAgICB2YXIgZG9tYWluID0gbGlzdFtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pZ25vcmVUcmFpbGluZ0RvdCkK
ICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbWFpbiA9IGRvbWFpbi5yZXBsYWNlKC9cLisk
LywgIiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZG9tYWluID09ICIiKQogICAgICAg
ICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAg
ICAgICAgICAgICAgICAgIHZhciBpbmNsdWRlOwogICAgICAgICAgICAgICAgICAgIGlmIChkb21haW4uY2hhckF0KDApID09ICJ+
IikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGUgPSBmYWxzZTsKICAgICAgICAg
ICAgICAgICAgICAgICAgZG9tYWluID0gZG9tYWluLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAg
ICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZSA9IHRydWU7
CiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0luY2x1ZGVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAg
ICAgICAgICAgICAgaWYgKCFkb21haW5zKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9t
YWlucyA9IGNyZWF0ZURpY3QoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZG9tYWluc1tkb21h
aW5dID0gaW5jbHVkZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRvbWFpbnNbIiJdID0gIWhhc0luY2x1ZGVz
OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZG9tYWluU291cmNlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0
dXJuIHRoaXMuZG9tYWluczsKICAgIH0sCiAgICBzaXRla2V5czogbnVsbCwKICAgIGlzQWN0aXZlT25Eb21haW46IGZ1bmN0aW9u
KGRvY0RvbWFpbiwgc2l0ZWtleSkKICAgIHsKICAgICAgICBpZiAodGhpcy5nZXRTaXRla2V5cygpICYmICghc2l0ZWtleSB8fCB0
aGlzLmdldFNpdGVrZXlzKCkuaW5kZXhPZihzaXRla2V5LnRvVXBwZXJDYXNlKCkpIDwgMCkpCiAgICAgICAgewogICAgICAgICAg
ICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5nZXREb21haW5zKCkpCiAgICAgICAgewogICAgICAg
ICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkb2NEb21haW4pCiAgICAgICAgewogICAgICAgICAgICBy
ZXR1cm4gdGhpcy5nZXREb21haW5zKClbIiJdOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5pZ25vcmVUcmFpbGluZ0RvdCkK
ICAgICAgICB7CiAgICAgICAgICAgIGRvY0RvbWFpbiA9IGRvY0RvbWFpbi5yZXBsYWNlKC9cLiskLywgIiIpOwogICAgICAgIH0K
ICAgICAgICBkb2NEb21haW4gPSBkb2NEb21haW4udG9VcHBlckNhc2UoKTsKICAgICAgICB3aGlsZSAodHJ1ZSkKICAgICAgICB7
CiAgICAgICAgICAgIGlmIChkb2NEb21haW4gaW4gdGhpcy5nZXREb21haW5zKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAg
ICAgIHJldHVybiB0aGlzLmRvbWFpbnNbZG9jRG9tYWluXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dERvdCA9
IGRvY0RvbWFpbi5pbmRleE9mKCIuIik7CiAgICAgICAgICAgIGlmIChuZXh0RG90IDwgMCkKICAgICAgICAgICAgewogICAgICAg
ICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jRG9tYWluID0gZG9jRG9tYWluLnN1YnN0cihuZXh0
RG90ICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmRvbWFpbnNbIiJdOwogICAgfSwKICAgIGlzQWN0aXZlT25s
eU9uRG9tYWluOiBmdW5jdGlvbihkb2NEb21haW4pCiAgICB7CiAgICAgICAgaWYgKCFkb2NEb21haW4gfHwgIXRoaXMuZ2V0RG9t
YWlucygpIHx8IHRoaXMuZ2V0RG9tYWlucygpWyIiXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAg
ICB9CiAgICAgICAgaWYgKHRoaXMuaWdub3JlVHJhaWxpbmdEb3QpCiAgICAgICAgewogICAgICAgICAgICBkb2NEb21haW4gPSBk
b2NEb21haW4ucmVwbGFjZSgvXC4rJC8sICIiKTsKICAgICAgICB9CiAgICAgICAgZG9jRG9tYWluID0gZG9jRG9tYWluLnRvVXBw
ZXJDYXNlKCk7CiAgICAgICAgZm9yICh2YXIgZG9tYWluIGluIHRoaXMuZ2V0RG9tYWlucygpKQogICAgICAgIHsKICAgICAgICAg
ICAgaWYgKHRoaXMuZG9tYWluc1tkb21haW5dICYmIGRvbWFpbiAhPSBkb2NEb21haW4gJiYgKGRvbWFpbi5sZW5ndGggPD0gZG9j
RG9tYWluLmxlbmd0aCB8fCBkb21haW4uaW5kZXhPZigiLiIgKyBkb2NEb21haW4pICE9IGRvbWFpbi5sZW5ndGggLSBkb2NEb21h
aW4ubGVuZ3RoIC0gMSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQog
ICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfSk7CgpmdW5jdGlvbiBSZWdFeHBGaWx0ZXIodGV4dCwgcmVnZXhw
U291cmNlLCBjb250ZW50VHlwZSwgbWF0Y2hDYXNlLCBkb21haW5zLCB0aGlyZFBhcnR5LCBzaXRla2V5cykKewogICAgQWN0aXZl
RmlsdGVyLmNhbGwodGhpcywgdGV4dCwgZG9tYWlucywgc2l0ZWtleXMpOwogICAgaWYgKGNvbnRlbnRUeXBlICE9IG51bGwpCiAg
ICB7CiAgICAgICAgdGhpcy5jb250ZW50VHlwZSA9IGNvbnRlbnRUeXBlOwogICAgfQogICAgaWYgKG1hdGNoQ2FzZSkKICAgIHsK
ICAgICAgICB0aGlzLm1hdGNoQ2FzZSA9IG1hdGNoQ2FzZTsKICAgIH0KICAgIGlmICh0aGlyZFBhcnR5ICE9IG51bGwpCiAgICB7
CiAgICAgICAgdGhpcy50aGlyZFBhcnR5ID0gdGhpcmRQYXJ0eTsKICAgIH0KICAgIGlmIChzaXRla2V5cyAhPSBudWxsKQogICAg
ewogICAgICAgIHRoaXMuc2l0ZWtleVNvdXJjZSA9IHNpdGVrZXlzOwogICAgfQogICAgaWYgKHJlZ2V4cFNvdXJjZS5sZW5ndGgg
Pj0gMiAmJiByZWdleHBTb3VyY2UuY2hhckF0KDApID09ICIvIiAmJiByZWdleHBTb3VyY2UuY2hhckF0KHJlZ2V4cFNvdXJjZS5s
ZW5ndGggLSAxKSA9PSAiLyIpCiAgICB7CiAgICAgICAgdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAocmVnZXhwU291cmNlLnN1YnN0
cigxLCByZWdleHBTb3VyY2UubGVuZ3RoIC0gMiksIHRoaXMubWF0Y2hDYXNlID8gIiIgOiAiaSIpOwogICAgICAgIHRoaXMucmVn
ZXhwID0gcmVnZXhwOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMucmVnZXhwU291cmNlID0gcmVnZXhwU291cmNl
OwogICAgfQp9CmV4dGVuZChSZWdFeHBGaWx0ZXIsIEFjdGl2ZUZpbHRlciwgewogICAgZG9tYWluU291cmNlSXNVcHBlckNhc2U6
IHRydWUsCiAgICBsZW5ndGg6IDEsCiAgICBkb21haW5TZXBhcmF0b3I6ICJ8IiwKICAgIHJlZ2V4cFNvdXJjZTogbnVsbCwKICAg
IGdldFJlZ2V4cDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBwcm9wID0gZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRo
aXMsICJyZWdleHAiKTsKICAgICAgICBpZiAocHJvcCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBwcm9wOwogICAgICAg
IH0KICAgICAgICB2YXIgc291cmNlID0gdGhpcy5yZWdleHBTb3VyY2UucmVwbGFjZSgvXCorL2csICIqIikucmVwbGFjZSgvXF5c
fCQvLCAiXiIpLnJlcGxhY2UoL1xXL2csICJcXCQmIikucmVwbGFjZSgvXFxcKi9nLCAiLioiKS5yZXBsYWNlKC9cXFxeL2csICIo
PzpbXFx4MDAtXFx4MjRcXHgyNi1cXHgyQ1xceDJGXFx4M0EtXFx4NDBcXHg1Qi1cXHg1RVxceDYwXFx4N0ItXFx4N0ZdfCQpIiku
cmVwbGFjZSgvXlxcXHxcXFx8LywgIl5bXFx3XFwtXSs6XFwvKyg/IVxcLykoPzpbXlxcL10rXFwuKT8iKS5yZXBsYWNlKC9eXFxc
fC8sICJeIikucmVwbGFjZSgvXFxcfCQvLCAiJCIpLnJlcGxhY2UoL14oXC5cKikvLCAiIikucmVwbGFjZSgvKFwuXCopJC8sICIi
KTsKICAgICAgICB2YXIgcmVnZXhwID0gbmV3IFJlZ0V4cChzb3VyY2UsIHRoaXMubWF0Y2hDYXNlID8gIiIgOiAiaSIpOwogICAg
ICAgIHRoaXMucmVnZXhwID0gcmVnZXhwOwogICAgICAgIHJldHVybiByZWdleHA7CiAgICB9LAogICAgY29udGVudFR5cGU6IDIx
NDc0ODM2NDcsCiAgICBtYXRjaENhc2U6IGZhbHNlLAogICAgdGhpcmRQYXJ0eTogbnVsbCwKICAgIHNpdGVrZXlTb3VyY2U6IG51
bGwsCiAgICBnZXRTaXRla2V5czogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBwcm9wID0gZ2V0T3duUHJvcGVydHlEZXNj
cmlwdG9yKHRoaXMsICJzaXRla2V5cyIpOwogICAgICAgIGlmIChwcm9wKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHBy
b3A7CiAgICAgICAgfQogICAgICAgIHZhciBzaXRla2V5cyA9IG51bGw7CiAgICAgICAgaWYgKHRoaXMuc2l0ZWtleVNvdXJjZSkK
ICAgICAgICB7CiAgICAgICAgICAgIHNpdGVrZXlzID0gdGhpcy5zaXRla2V5U291cmNlLnNwbGl0KCJ8Iik7CiAgICAgICAgICAg
IHRoaXMuc2l0ZWtleVNvdXJjZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2l0ZWtleXMgPSBzaXRla2V5czsKICAg
ICAgICByZXR1cm4gdGhpcy5zaXRla2V5czsKICAgIH0sCiAgICBtYXRjaGVzOiBmdW5jdGlvbihsb2NhdGlvbiwgY29udGVudFR5
cGUsIGRvY0RvbWFpbiwgdGhpcmRQYXJ0eSwgc2l0ZWtleSkKICAgIHsKICAgICAgICBpZiAodGhpcy5nZXRSZWdleHAoKS50ZXN0
KGxvY2F0aW9uKSAmJiB0aGlzLmlzQWN0aXZlT25Eb21haW4oZG9jRG9tYWluLCBzaXRla2V5KSkKICAgICAgICB7CiAgICAgICAg
ICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0pOwpSZWdFeHBGaWx0ZXIucHJv
dG90eXBlWyIwIl0gPSAiI3RoaXMiOwpSZWdFeHBGaWx0ZXIuZnJvbVRleHQgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICB2YXIgYmxv
Y2tpbmcgPSB0cnVlOwogICAgdmFyIG9yaWdUZXh0ID0gdGV4dDsKICAgIGlmICh0ZXh0LmluZGV4T2YoIkBAIikgPT0gMCkKICAg
IHsKICAgICAgICBibG9ja2luZyA9IGZhbHNlOwogICAgICAgIHRleHQgPSB0ZXh0LnN1YnN0cigyKTsKICAgIH0KICAgIHZhciBj
b250ZW50VHlwZSA9IG51bGw7CiAgICB2YXIgbWF0Y2hDYXNlID0gbnVsbDsKICAgIHZhciBkb21haW5zID0gbnVsbDsKICAgIHZh
ciBzaXRla2V5cyA9IG51bGw7CiAgICB2YXIgdGhpcmRQYXJ0eSA9IG51bGw7CiAgICB2YXIgY29sbGFwc2UgPSBudWxsOwogICAg
dmFyIG9wdGlvbnM7CiAgICB2YXIgbWF0Y2ggPSB0ZXh0LmluZGV4T2YoIiQiKSA+PSAwID8gRmlsdGVyLm9wdGlvbnNSZWdFeHAu
ZXhlYyh0ZXh0KSA6IG51bGw7CiAgICBpZiAobWF0Y2gpCiAgICB7CiAgICAgICAgb3B0aW9ucyA9IG1hdGNoWzFdLnRvVXBwZXJD
YXNlKCkuc3BsaXQoIiwiKTsKICAgICAgICB0ZXh0ID0gbWF0Y2guaW5wdXQuc3Vic3RyKDAsIG1hdGNoLmluZGV4KTsKICAgICAg
ICBmb3IgKHZhciBfbG9vcEluZGV4NiA9IDA7IF9sb29wSW5kZXg2IDwgb3B0aW9ucy5sZW5ndGg7ICsrX2xvb3BJbmRleDYpCiAg
ICAgICAgewogICAgICAgICAgICB2YXIgb3B0aW9uID0gb3B0aW9uc1tfbG9vcEluZGV4Nl07CiAgICAgICAgICAgIHZhciB2YWx1
ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBzZXBhcmF0b3JJbmRleCA9IG9wdGlvbi5pbmRleE9mKCI9Iik7CiAgICAgICAgICAg
IGlmIChzZXBhcmF0b3JJbmRleCA+PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG9wdGlvbi5zdWJz
dHIoc2VwYXJhdG9ySW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbi5zdWJzdHIoMCwgc2VwYXJhdG9y
SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbi5yZXBsYWNlKC8tLywgIl8iKTsKICAgICAg
ICAgICAgaWYgKG9wdGlvbiBpbiBSZWdFeHBGaWx0ZXIudHlwZU1hcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYg
KGNvbnRlbnRUeXBlID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGUgPSAw
OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGVudFR5cGUgfD0gUmVnRXhwRmlsdGVyLnR5cGVNYXBbb3B0
aW9uXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChvcHRpb24uY2hhckF0KDApID09ICJ+IiAmJiBvcHRpb24u
c3Vic3RyKDEpIGluIFJlZ0V4cEZpbHRlci50eXBlTWFwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY29udGVu
dFR5cGUgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb250ZW50VHlwZSA9IFJlZ0V4cEZp
bHRlci5wcm90b3R5cGUuY29udGVudFR5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250ZW50VHlwZSAm
PSB+UmVnRXhwRmlsdGVyLnR5cGVNYXBbb3B0aW9uLnN1YnN0cigxKV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBp
ZiAob3B0aW9uID09ICJNQVRDSF9DQVNFIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWF0Y2hDYXNlID0gdHJ1ZTsK
ICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChvcHRpb24gPT0gIn5NQVRDSF9DQVNFIikKICAgICAgICAgICAgewog
ICAgICAgICAgICAgICAgbWF0Y2hDYXNlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9u
ID09ICJET01BSU4iICYmIHR5cGVvZiB2YWx1ZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAg
ZG9tYWlucyA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wdGlvbiA9PSAiVEhJUkRfUEFSVFki
KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlyZFBhcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAg
ICBlbHNlIGlmIChvcHRpb24gPT0gIn5USElSRF9QQVJUWSIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXJkUGFy
dHkgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChvcHRpb24gPT0gIkNPTExBUFNFIikKICAgICAg
ICAgICAgewogICAgICAgICAgICAgICAgY29sbGFwc2UgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYg
KG9wdGlvbiA9PSAifkNPTExBUFNFIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29sbGFwc2UgPSBmYWxzZTsKICAg
ICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChvcHRpb24gPT0gIlNJVEVLRVkiICYmIHR5cGVvZiB2YWx1ZSAhPSAidW5k
ZWZpbmVkIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2l0ZWtleXMgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAg
ICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW52YWxpZEZpbHRlcihvcmlnVGV4
dCwgIlVua25vd24gb3B0aW9uICIgKyBvcHRpb24udG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9
CiAgICBpZiAoIWJsb2NraW5nICYmIChjb250ZW50VHlwZSA9PSBudWxsIHx8IGNvbnRlbnRUeXBlICYgUmVnRXhwRmlsdGVyLnR5
cGVNYXAuRE9DVU1FTlQpICYmICghb3B0aW9ucyB8fCBvcHRpb25zLmluZGV4T2YoIkRPQ1VNRU5UIikgPCAwKSAmJiAhL15cfD9b
XHdcLV0rOi8udGVzdCh0ZXh0KSkKICAgIHsKICAgICAgICBpZiAoY29udGVudFR5cGUgPT0gbnVsbCkKICAgICAgICB7CiAgICAg
ICAgICAgIGNvbnRlbnRUeXBlID0gUmVnRXhwRmlsdGVyLnByb3RvdHlwZS5jb250ZW50VHlwZTsKICAgICAgICB9CiAgICAgICAg
Y29udGVudFR5cGUgJj0gflJlZ0V4cEZpbHRlci50eXBlTWFwLkRPQ1VNRU5UOwogICAgfQogICAgdHJ5CiAgICB7CiAgICAgICAg
aWYgKGJsb2NraW5nKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBCbG9ja2luZ0ZpbHRlcihvcmlnVGV4dCwgdGV4
dCwgY29udGVudFR5cGUsIG1hdGNoQ2FzZSwgZG9tYWlucywgdGhpcmRQYXJ0eSwgc2l0ZWtleXMsIGNvbGxhcHNlKTsKICAgICAg
ICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBXaGl0ZWxpc3RGaWx0ZXIob3JpZ1RleHQs
IHRleHQsIGNvbnRlbnRUeXBlLCBtYXRjaENhc2UsIGRvbWFpbnMsIHRoaXJkUGFydHksIHNpdGVrZXlzKTsKICAgICAgICB9CiAg
ICB9CiAgICBjYXRjaCAoZSkKICAgIHsKICAgICAgICByZXR1cm4gbmV3IEludmFsaWRGaWx0ZXIob3JpZ1RleHQsIGUpOwogICAg
fQp9OwpSZWdFeHBGaWx0ZXIudHlwZU1hcCA9IHsKICAgIE9USEVSOiAxLAogICAgU0NSSVBUOiAyLAogICAgSU1BR0U6IDQsCiAg
ICBTVFlMRVNIRUVUOiA4LAogICAgT0JKRUNUOiAxNiwKICAgIFNVQkRPQ1VNRU5UOiAzMiwKICAgIERPQ1VNRU5UOiA2NCwKICAg
IFhCTDogMSwKICAgIFBJTkc6IDEsCiAgICBYTUxIVFRQUkVRVUVTVDogMjA0OCwKICAgIE9CSkVDVF9TVUJSRVFVRVNUOiA0MDk2
LAogICAgRFREOiAxLAogICAgTUVESUE6IDE2Mzg0LAogICAgRk9OVDogMzI3NjgsCiAgICBCQUNLR1JPVU5EOiA0LAogICAgUE9Q
VVA6IDI2ODQzNTQ1NiwKICAgIEVMRU1ISURFOiAxMDczNzQxODI0Cn07ClJlZ0V4cEZpbHRlci5wcm90b3R5cGUuY29udGVudFR5
cGUgJj0gfiAoUmVnRXhwRmlsdGVyLnR5cGVNYXAuRUxFTUhJREUgfCBSZWdFeHBGaWx0ZXIudHlwZU1hcC5QT1BVUCk7CgpmdW5j
dGlvbiBCbG9ja2luZ0ZpbHRlcih0ZXh0LCByZWdleHBTb3VyY2UsIGNvbnRlbnRUeXBlLCBtYXRjaENhc2UsIGRvbWFpbnMsIHRo
aXJkUGFydHksIHNpdGVrZXlzLCBjb2xsYXBzZSkKewogICAgUmVnRXhwRmlsdGVyLmNhbGwodGhpcywgdGV4dCwgcmVnZXhwU291
cmNlLCBjb250ZW50VHlwZSwgbWF0Y2hDYXNlLCBkb21haW5zLCB0aGlyZFBhcnR5LCBzaXRla2V5cyk7CiAgICB0aGlzLmNvbGxh
cHNlID0gY29sbGFwc2U7Cn0KZXh0ZW5kKEJsb2NraW5nRmlsdGVyLCBSZWdFeHBGaWx0ZXIsIHsKICAgIGNvbGxhcHNlOiBudWxs
Cn0pOwoKZnVuY3Rpb24gV2hpdGVsaXN0RmlsdGVyKHRleHQsIHJlZ2V4cFNvdXJjZSwgY29udGVudFR5cGUsIG1hdGNoQ2FzZSwg
ZG9tYWlucywgdGhpcmRQYXJ0eSwgc2l0ZWtleXMpCnsKICAgIFJlZ0V4cEZpbHRlci5jYWxsKHRoaXMsIHRleHQsIHJlZ2V4cFNv
dXJjZSwgY29udGVudFR5cGUsIG1hdGNoQ2FzZSwgZG9tYWlucywgdGhpcmRQYXJ0eSwgc2l0ZWtleXMpOwp9CmV4dGVuZChXaGl0
ZWxpc3RGaWx0ZXIsIFJlZ0V4cEZpbHRlciwgewp9KTsKCmZ1bmN0aW9uIE1hdGNoZXIoKQp7CiAgICB0aGlzLmNsZWFyKCk7Cn0K
TWF0Y2hlci5wcm90b3R5cGUgPSB7CiAgICBmaWx0ZXJCeUtleXdvcmQ6IG51bGwsCiAgICBrZXl3b3JkQnlGaWx0ZXI6IG51bGws
CiAgICBjbGVhcjogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuZmlsdGVyQnlLZXl3b3JkID0gY3JlYXRlRGljdCgpOwog
ICAgICAgIHRoaXMua2V5d29yZEJ5RmlsdGVyID0gY3JlYXRlRGljdCgpOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24oZmlsdGVy
KQogICAgewogICAgICAgIGlmIChmaWx0ZXIudGV4dCBpbiB0aGlzLmtleXdvcmRCeUZpbHRlcikKICAgICAgICB7CiAgICAgICAg
ICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGtleXdvcmQgPSB0aGlzLmZpbmRLZXl3b3JkKGZpbHRlcik7CiAgICAg
ICAgdmFyIG9sZEVudHJ5ID0gdGhpcy5maWx0ZXJCeUtleXdvcmRba2V5d29yZF07CiAgICAgICAgaWYgKHR5cGVvZiBvbGRFbnRy
eSA9PSAidW5kZWZpbmVkIikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tleXdvcmRdID0gZmls
dGVyOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChvbGRFbnRyeS5sZW5ndGggPT0gMSkKICAgICAgICB7CiAgICAgICAgICAg
IHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tleXdvcmRdID0gW29sZEVudHJ5LCBmaWx0ZXJdOwogICAgICAgIH0KICAgICAgICBlbHNl
CiAgICAgICAgewogICAgICAgICAgICBvbGRFbnRyeS5wdXNoKGZpbHRlcik7CiAgICAgICAgfQogICAgICAgIHRoaXMua2V5d29y
ZEJ5RmlsdGVyW2ZpbHRlci50ZXh0XSA9IGtleXdvcmQ7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihmaWx0ZXIpCiAgICB7
CiAgICAgICAgaWYgKCEoZmlsdGVyLnRleHQgaW4gdGhpcy5rZXl3b3JkQnlGaWx0ZXIpKQogICAgICAgIHsKICAgICAgICAgICAg
cmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIga2V5d29yZCA9IHRoaXMua2V5d29yZEJ5RmlsdGVyW2ZpbHRlci50ZXh0XTsK
ICAgICAgICB2YXIgbGlzdCA9IHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tleXdvcmRdOwogICAgICAgIGlmIChsaXN0Lmxlbmd0aCA8
PSAxKQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tleXdvcmRdOwogICAgICAgIH0K
ICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgaW5kZXggPSBsaXN0LmluZGV4T2YoZmlsdGVyKTsKICAgICAg
ICAgICAgaWYgKGluZGV4ID49IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpc3Quc3BsaWNlKGluZGV4LCAxKTsK
ICAgICAgICAgICAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PSAxKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAg
IHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tleXdvcmRdID0gbGlzdFswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQog
ICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5rZXl3b3JkQnlGaWx0ZXJbZmlsdGVyLnRleHRdOwogICAgfSwKICAgIGZpbmRL
ZXl3b3JkOiBmdW5jdGlvbihmaWx0ZXIpCiAgICB7CiAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgIHZhciB0ZXh0ID0g
ZmlsdGVyLnRleHQ7CiAgICAgICAgaWYgKEZpbHRlci5yZWdleHBSZWdFeHAudGVzdCh0ZXh0KSkKICAgICAgICB7CiAgICAgICAg
ICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHZhciBtYXRjaCA9IEZpbHRlci5vcHRpb25zUmVnRXhwLmV4ZWMo
dGV4dCk7CiAgICAgICAgaWYgKG1hdGNoKQogICAgICAgIHsKICAgICAgICAgICAgdGV4dCA9IG1hdGNoLmlucHV0LnN1YnN0cigw
LCBtYXRjaC5pbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmICh0ZXh0LnN1YnN0cigwLCAyKSA9PSAiQEAiKQogICAgICAgIHsK
ICAgICAgICAgICAgdGV4dCA9IHRleHQuc3Vic3RyKDIpOwogICAgICAgIH0KICAgICAgICB2YXIgY2FuZGlkYXRlcyA9IHRleHQu
dG9Mb3dlckNhc2UoKS5tYXRjaCgvW15hLXowLTklKl1bYS16MC05JV17Myx9KD89W15hLXowLTklKl0pL2cpOwogICAgICAgIGlm
ICghY2FuZGlkYXRlcykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHZhciBo
YXNoID0gdGhpcy5maWx0ZXJCeUtleXdvcmQ7CiAgICAgICAgdmFyIHJlc3VsdENvdW50ID0gMTY3NzcyMTU7CiAgICAgICAgdmFy
IHJlc3VsdExlbmd0aCA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjYW5kaWRhdGVzLmxlbmd0aDsgaSA8IGw7IGkr
KykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBjYW5kaWRhdGVzW2ldLnN1YnN0cigxKTsKICAgICAgICAg
ICAgdmFyIGNvdW50ID0gY2FuZGlkYXRlIGluIGhhc2ggPyBoYXNoW2NhbmRpZGF0ZV0ubGVuZ3RoIDogMDsKICAgICAgICAgICAg
aWYgKGNvdW50IDwgcmVzdWx0Q291bnQgfHwgY291bnQgPT0gcmVzdWx0Q291bnQgJiYgY2FuZGlkYXRlLmxlbmd0aCA+IHJlc3Vs
dExlbmd0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gY2FuZGlkYXRlOwogICAgICAgICAgICAgICAg
cmVzdWx0Q291bnQgPSBjb3VudDsKICAgICAgICAgICAgICAgIHJlc3VsdExlbmd0aCA9IGNhbmRpZGF0ZS5sZW5ndGg7CiAgICAg
ICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBoYXNGaWx0ZXI6IGZ1bmN0aW9uKGZp
bHRlcikKICAgIHsKICAgICAgICByZXR1cm4gZmlsdGVyLnRleHQgaW4gdGhpcy5rZXl3b3JkQnlGaWx0ZXI7CiAgICB9LAogICAg
Z2V0S2V5d29yZEZvckZpbHRlcjogZnVuY3Rpb24oZmlsdGVyKQogICAgewogICAgICAgIGlmIChmaWx0ZXIudGV4dCBpbiB0aGlz
LmtleXdvcmRCeUZpbHRlcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmtleXdvcmRCeUZpbHRlcltmaWx0ZXIu
dGV4dF07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0K
ICAgIH0sCiAgICBfY2hlY2tFbnRyeU1hdGNoOiBmdW5jdGlvbihrZXl3b3JkLCBsb2NhdGlvbiwgY29udGVudFR5cGUsIGRvY0Rv
bWFpbiwgdGhpcmRQYXJ0eSwgc2l0ZWtleSkKICAgIHsKICAgICAgICB2YXIgbGlzdCA9IHRoaXMuZmlsdGVyQnlLZXl3b3JkW2tl
eXdvcmRdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAg
IHZhciBmaWx0ZXIgPSBsaXN0W2ldOwogICAgICAgICAgICBpZiAoZmlsdGVyID09ICIjdGhpcyIpCiAgICAgICAgICAgIHsKICAg
ICAgICAgICAgICAgIGZpbHRlciA9IGxpc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpbHRlci5tYXRjaGVzKGxv
Y2F0aW9uLCBjb250ZW50VHlwZSwgZG9jRG9tYWluLCB0aGlyZFBhcnR5LCBzaXRla2V5KSkKICAgICAgICAgICAgewogICAgICAg
ICAgICAgICAgcmV0dXJuIGZpbHRlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0s
CiAgICBtYXRjaGVzQW55OiBmdW5jdGlvbihsb2NhdGlvbiwgY29udGVudFR5cGUsIGRvY0RvbWFpbiwgdGhpcmRQYXJ0eSwgc2l0
ZWtleSkKICAgIHsKICAgICAgICB2YXIgY2FuZGlkYXRlcyA9IGxvY2F0aW9uLnRvTG93ZXJDYXNlKCkubWF0Y2goL1thLXowLTkl
XXszLH0vZyk7CiAgICAgICAgaWYgKGNhbmRpZGF0ZXMgPT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBjYW5kaWRhdGVz
ID0gW107CiAgICAgICAgfQogICAgICAgIGNhbmRpZGF0ZXMucHVzaCgiIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBj
YW5kaWRhdGVzLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdWJzdHIgPSBjYW5kaWRhdGVz
W2ldOwogICAgICAgICAgICBpZiAoc3Vic3RyIGluIHRoaXMuZmlsdGVyQnlLZXl3b3JkKQogICAgICAgICAgICB7CiAgICAgICAg
ICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5fY2hlY2tFbnRyeU1hdGNoKHN1YnN0ciwgbG9jYXRpb24sIGNvbnRlbnRUeXBlLCBk
b2NEb21haW4sIHRoaXJkUGFydHksIHNpdGVrZXkpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICAgICAgICAg
IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAg
ICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQp9OwoKZnVuY3Rpb24gQ29tYmluZWRNYXRjaGVyKCkKewogICAgdGhpcy5i
bGFja2xpc3QgPSBuZXcgTWF0Y2hlcigpOwogICAgdGhpcy53aGl0ZWxpc3QgPSBuZXcgTWF0Y2hlcigpOwogICAgdGhpcy5yZXN1
bHRDYWNoZSA9IGNyZWF0ZURpY3QoKTsKfQpDb21iaW5lZE1hdGNoZXIubWF4Q2FjaGVFbnRyaWVzID0gMTAwMDsKQ29tYmluZWRN
YXRjaGVyLnByb3RvdHlwZSA9IHsKICAgIGJsYWNrbGlzdDogbnVsbCwKICAgIHdoaXRlbGlzdDogbnVsbCwKICAgIHJlc3VsdENh
Y2hlOiBudWxsLAogICAgY2FjaGVFbnRyaWVzOiAwLAogICAgY2xlYXI6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLmJs
YWNrbGlzdC5jbGVhcigpOwogICAgICAgIHRoaXMud2hpdGVsaXN0LmNsZWFyKCk7CiAgICAgICAgdGhpcy5yZXN1bHRDYWNoZSA9
IGNyZWF0ZURpY3QoKTsKICAgICAgICB0aGlzLmNhY2hlRW50cmllcyA9IDA7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbihmaWx0
ZXIpCiAgICB7CiAgICAgICAgaWYgKGZpbHRlciBpbnN0YW5jZW9mIFdoaXRlbGlzdEZpbHRlcikKICAgICAgICB7CiAgICAgICAg
ICAgIHRoaXMud2hpdGVsaXN0LmFkZChmaWx0ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAg
ICB0aGlzLmJsYWNrbGlzdC5hZGQoZmlsdGVyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuY2FjaGVFbnRyaWVzID4gMCkK
ICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVzdWx0Q2FjaGUgPSBjcmVhdGVEaWN0KCk7CiAgICAgICAgICAgIHRoaXMuY2Fj
aGVFbnRyaWVzID0gMDsKICAgICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihmaWx0ZXIpCiAgICB7CiAgICAgICAg
aWYgKGZpbHRlciBpbnN0YW5jZW9mIFdoaXRlbGlzdEZpbHRlcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2hpdGVsaXN0
LnJlbW92ZShmaWx0ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJsYWNrbGlz
dC5yZW1vdmUoZmlsdGVyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuY2FjaGVFbnRyaWVzID4gMCkKICAgICAgICB7CiAg
ICAgICAgICAgIHRoaXMucmVzdWx0Q2FjaGUgPSBjcmVhdGVEaWN0KCk7CiAgICAgICAgICAgIHRoaXMuY2FjaGVFbnRyaWVzID0g
MDsKICAgICAgICB9CiAgICB9LAogICAgZmluZEtleXdvcmQ6IGZ1bmN0aW9uKGZpbHRlcikKICAgIHsKICAgICAgICBpZiAoZmls
dGVyIGluc3RhbmNlb2YgV2hpdGVsaXN0RmlsdGVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMud2hpdGVsaXN0
LmZpbmRLZXl3b3JkKGZpbHRlcik7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0
aGlzLmJsYWNrbGlzdC5maW5kS2V5d29yZChmaWx0ZXIpOwogICAgICAgIH0KICAgIH0sCiAgICBoYXNGaWx0ZXI6IGZ1bmN0aW9u
KGZpbHRlcikKICAgIHsKICAgICAgICBpZiAoZmlsdGVyIGluc3RhbmNlb2YgV2hpdGVsaXN0RmlsdGVyKQogICAgICAgIHsKICAg
ICAgICAgICAgcmV0dXJuIHRoaXMud2hpdGVsaXN0Lmhhc0ZpbHRlcihmaWx0ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAg
ICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ibGFja2xpc3QuaGFzRmlsdGVyKGZpbHRlcik7CiAgICAgICAgfQogICAg
fSwKICAgIGdldEtleXdvcmRGb3JGaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlcikKICAgIHsKICAgICAgICBpZiAoZmlsdGVyIGluc3Rh
bmNlb2YgV2hpdGVsaXN0RmlsdGVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMud2hpdGVsaXN0LmdldEtleXdv
cmRGb3JGaWx0ZXIoZmlsdGVyKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRo
aXMuYmxhY2tsaXN0LmdldEtleXdvcmRGb3JGaWx0ZXIoZmlsdGVyKTsKICAgICAgICB9CiAgICB9LAogICAgaXNTbG93RmlsdGVy
OiBmdW5jdGlvbihmaWx0ZXIpCiAgICB7CiAgICAgICAgdmFyIG1hdGNoZXIgPSBmaWx0ZXIgaW5zdGFuY2VvZiBXaGl0ZWxpc3RG
aWx0ZXIgPyB0aGlzLndoaXRlbGlzdCA6IHRoaXMuYmxhY2tsaXN0OwogICAgICAgIGlmIChtYXRjaGVyLmhhc0ZpbHRlcihmaWx0
ZXIpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuICFtYXRjaGVyLmdldEtleXdvcmRGb3JGaWx0ZXIoZmlsdGVyKTsKICAg
ICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuICFtYXRjaGVyLmZpbmRLZXl3b3JkKGZpbHRl
cik7CiAgICAgICAgfQogICAgfSwKICAgIG1hdGNoZXNBbnlJbnRlcm5hbDogZnVuY3Rpb24obG9jYXRpb24sIGNvbnRlbnRUeXBl
LCBkb2NEb21haW4sIHRoaXJkUGFydHksIHNpdGVrZXkpCiAgICB7CiAgICAgICAgdmFyIGNhbmRpZGF0ZXMgPSBsb2NhdGlvbi50
b0xvd2VyQ2FzZSgpLm1hdGNoKC9bYS16MC05JV17Myx9L2cpOwogICAgICAgIGlmIChjYW5kaWRhdGVzID09PSBudWxsKQogICAg
ICAgIHsKICAgICAgICAgICAgY2FuZGlkYXRlcyA9IFtdOwogICAgICAgIH0KICAgICAgICBjYW5kaWRhdGVzLnB1c2goIiIpOwog
ICAgICAgIHZhciBibGFja2xpc3RIaXQgPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2FuZGlkYXRlcy5sZW5n
dGg7IGkgPCBsOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgc3Vic3RyID0gY2FuZGlkYXRlc1tpXTsKICAgICAgICAg
ICAgaWYgKHN1YnN0ciBpbiB0aGlzLndoaXRlbGlzdC5maWx0ZXJCeUtleXdvcmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAg
ICAgIHZhciByZXN1bHQgPSB0aGlzLndoaXRlbGlzdC5fY2hlY2tFbnRyeU1hdGNoKHN1YnN0ciwgbG9jYXRpb24sIGNvbnRlbnRU
eXBlLCBkb2NEb21haW4sIHRoaXJkUGFydHksIHNpdGVrZXkpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICAg
ICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9
CiAgICAgICAgICAgIGlmIChzdWJzdHIgaW4gdGhpcy5ibGFja2xpc3QuZmlsdGVyQnlLZXl3b3JkICYmIGJsYWNrbGlzdEhpdCA9
PT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYmxhY2tsaXN0SGl0ID0gdGhpcy5ibGFja2xpc3QuX2NoZWNr
RW50cnlNYXRjaChzdWJzdHIsIGxvY2F0aW9uLCBjb250ZW50VHlwZSwgZG9jRG9tYWluLCB0aGlyZFBhcnR5LCBzaXRla2V5KTsK
ICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYmxhY2tsaXN0SGl0OwogICAgfSwKICAgIG1hdGNoZXNBbnk6
IGZ1bmN0aW9uKGxvY2F0aW9uLCBkb2NEb21haW4pCiAgICB7CiAgICAgICAgdmFyIGtleSA9IGxvY2F0aW9uICsgIiAiICsgZG9j
RG9tYWluICsgIiAiOwogICAgICAgIGlmIChrZXkgaW4gdGhpcy5yZXN1bHRDYWNoZSkKICAgICAgICB7CiAgICAgICAgICAgIHJl
dHVybiB0aGlzLnJlc3VsdENhY2hlW2tleV07CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSB0aGlzLm1hdGNoZXNBbnlJ
bnRlcm5hbChsb2NhdGlvbiwgMCwgZG9jRG9tYWluLCBudWxsLCBudWxsKTsKICAgICAgICBpZiAodGhpcy5jYWNoZUVudHJpZXMg
Pj0gQ29tYmluZWRNYXRjaGVyLm1heENhY2hlRW50cmllcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVzdWx0Q2FjaGUg
PSBjcmVhdGVEaWN0KCk7CiAgICAgICAgICAgIHRoaXMuY2FjaGVFbnRyaWVzID0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5y
ZXN1bHRDYWNoZVtrZXldID0gcmVzdWx0OwogICAgICAgIHRoaXMuY2FjaGVFbnRyaWVzKys7CiAgICAgICAgcmV0dXJuIHJlc3Vs
dDsKICAgIH0KfTsKdmFyIGRlZmF1bHRNYXRjaGVyID0gbmV3IENvbWJpbmVkTWF0Y2hlcigpOwoKdmFyIGRpcmVjdCA9ICdESVJF
Q1Q7JzsKCmZvciAodmFyIGkgPSAwOyBpIDwgcnVsZXMubGVuZ3RoOyBpKyspIHsKICAgIGRlZmF1bHRNYXRjaGVyLmFkZChGaWx0
ZXIuZnJvbVRleHQocnVsZXNbaV0pKTsKfQoKZnVuY3Rpb24gRmluZFByb3h5Rm9yVVJMKHVybCwgaG9zdCkgewogICAgaWYgKGRl
ZmF1bHRNYXRjaGVyLm1hdGNoZXNBbnkodXJsLCBob3N0KSBpbnN0YW5jZW9mIEJsb2NraW5nRmlsdGVyKSB7CiAgICAgICAgcmV0
dXJuIHByb3h5OwogICAgfQogICAgcmV0dXJuIGRpcmVjdDsKfQo='

SR_BASE_CODE='W0dlbmVyYWxdCmJ5cGFzcy1zeXN0ZW0gPSB0cnVlCnNraXAtcHJveHkgPSAxOTIuMTY4LjAuMC8xNiwgMTAuMC4wLjAvOCwgMTcy
LjE2LjAuMC8xMiwgbG9jYWxob3N0LCAqLmxvY2FsLCBlLmNyYXNobHl0aWNzLmNvbSwgY2FwdGl2ZS5hcHBsZS5jb20KYnlwYXNz
LXR1biA9IDEwLjAuMC4wLzgsMTAwLjY0LjAuMC8xMCwxMjcuMC4wLjAvOCwxNjkuMjU0LjAuMC8xNiwxNzIuMTYuMC4wLzEyLDE5
Mi4wLjAuMC8yNCwxOTIuMC4yLjAvMjQsMTkyLjg4Ljk5LjAvMjQsMTkyLjE2OC4wLjAvMTYsMTk4LjE4LjAuMC8xNSwxOTguNTEu
MTAwLjAvMjQsMjAzLjAuMTEzLjAvMjQsMjI0LjAuMC4wLzQsMjU1LjI1NS4yNTUuMjU1LzMyCmRucy1zZXJ2ZXIgPSA4LjguOC44
LDguOC40LjQKCltSdWxlXQp7e1JVTEVTfX0KSVAtQ0lEUiw5MS4xMDguNTYuMC8yMixQUk9YWSxuby1yZXNvbHZlCklQLUNJRFIs
OTEuMTA4LjQuMC8yMixQUk9YWSxuby1yZXNvbHZlCklQLUNJRFIsMTA5LjIzOS4xNDAuMC8yNCxQUk9YWSxuby1yZXNvbHZlCklQ
LUNJRFIsMTQ5LjE1NC4xNjAuMC8yMCxQUk9YWSxuby1yZXNvbHZlCklQLUNJRFIsMTkyLjE2OC4wLjAvMTYsRElSRUNUCklQLUNJ
RFIsMTAuMC4wLjAvOCxESVJFQ1QKSVAtQ0lEUiwxNzIuMTYuMC4wLzEyLERJUkVDVApJUC1DSURSLDEyNy4wLjAuMC84LERJUkVD
VApHRU9JUCxDTixESVJFQ1QKRklOQUwsRElSRUNUCgpbSG9zdF0KbG9jYWxob3N0ID0gMTI3LjAuMC4xCgpbVVJMIFJld3JpdGVd
Cl5odHRwOi8vKHd3dy4pP2cuY24gaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbSAzMDIKXmh0dHA6Ly8od3d3Lik/Z29vZ2xlLmNuIGh0
dHBzOi8vd3d3Lmdvb2dsZS5jb20gMzAyCl5odHRwOi8vcmVqZWN0LmV4YW1wbGUuY29tIHJlamVjdCAKCg=='

#main begin
__method=$1
if [[ ! ${__method} =~ [123] ]]; then
	__method=3
fi
# 1 gfwlist2pac
# 2 genPac
# 3 bash
# 4 is to generate shadowrocket version
_convert ${__method} $2
